"""
–ú–æ–¥—É–ª—å "—É–º–Ω–æ–π" —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –∫–ª—é—á–µ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤
"""

import logging
import re
from typing import Dict, List, Optional, Tuple
from groq import Groq

logger = logging.getLogger(__name__)

class SmartSummarizer:
    """–ö–ª–∞—Å—Å –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤"""
    
    def __init__(self, groq_client: Groq):
        self.groq_client = groq_client
        
    def analyze_content_type(self, text: str, source_type: str = "text") -> str:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥—è—â–µ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏"""
        text_lower = text.lower()
        
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        content_patterns = {
            "meeting": ["–≤—Å—Ç—Ä–µ—á–∞", "—Å–æ–±—Ä–∞–Ω–∏–µ", "–æ–±—Å—É–∂–¥–∞–ª–∏", "—Ä–µ—à–∏–ª–∏", "action item", "—Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏", "–ø–æ–≤–µ—Å—Ç–∫–∞"],
            "lecture": ["–ª–µ–∫—Ü–∏—è", "—É—Ä–æ–∫", "–æ–±—ä—è—Å–Ω—é", "–∏–∑—É—á–∞–µ–º", "—Ç–µ–º–∞ —É—Ä–æ–∫–∞", "–≤—ã–≤–æ–¥—ã", "–º–∞—Ç–µ—Ä–∏–∞–ª"],
            "news": ["–Ω–æ–≤–æ—Å—Ç–∏", "–ø—Ä–æ–∏–∑–æ—à–ª–æ", "—Å–æ–æ–±—â–∞–µ—Ç—Å—è", "–ø–æ –¥–∞–Ω–Ω—ã–º", "–∏—Å—Ç–æ—á–Ω–∏–∫–∏", "–∑–∞—è–≤–∏–ª"],
            "interview": ["–∏–Ω—Ç–µ—Ä–≤—å—é", "–±–µ—Å–µ–¥–∞", "–≤–æ–ø—Ä–æ—Å", "–æ—Ç–≤–µ—Ç", "—Ä–∞—Å—Å–∫–∞–∑–∞–ª", "–ø–æ–¥–µ–ª–∏–ª—Å—è"],
            "presentation": ["–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è", "–¥–æ–∫–ª–∞–¥", "—Å–ª–∞–π–¥", "–ø–æ–∫–∞–∂—É", "–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è"],
            "discussion": ["–¥–∏—Å–∫—É—Å—Å–∏—è", "–æ–±—Å—É–∂–¥–µ–Ω–∏–µ", "–º–Ω–µ–Ω–∏–µ", "—Ç–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è", "—Å—á–∏—Ç–∞—é", "—Å–æ–≥–ª–∞—Å–µ–Ω"],
            "instruction": ["–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", "–∫–∞–∫", "—à–∞–≥–∏", "—Å–Ω–∞—á–∞–ª–∞", "–∑–∞—Ç–µ–º", "—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ"],
            "review": ["–æ–±–∑–æ—Ä", "—Ä–µ—Ü–µ–Ω–∑–∏—è", "–æ—Ü–µ–Ω–∫–∞", "–ø–ª—é—Å—ã", "–º–∏–Ω—É—Å—ã", "—Ä–µ–∫–æ–º–µ–Ω–¥—É—é"]
        }
        
        scores = {}
        for content_type, keywords in content_patterns.items():
            score = sum(1 for keyword in keywords if keyword in text_lower)
            if score > 0:
                scores[content_type] = score
        
        if scores:
            return max(scores, key=scores.get)
        
        # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–∏–ø –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        if source_type == "audio":
            return "discussion"
        elif source_type == "document":
            return "instruction"
        else:
            return "general"
    
    def extract_key_entities(self, text: str) -> Dict[str, List[str]]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        entities = {
            "dates": [],
            "numbers": [],
            "names": [],
            "actions": [],
            "decisions": []
        }
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞—Ç
        date_patterns = [
            r'\d{1,2}\.\d{1,2}\.\d{4}',  # 01.01.2024
            r'\d{1,2}/\d{1,2}/\d{4}',   # 01/01/2024
            r'\d{1,2} [–∞-—è]+ \d{4}',    # 1 —è–Ω–≤–∞—Ä—è 2024
            r'[–∞-—è]+ \d{4}',            # —è–Ω–≤–∞—Ä—å 2024
        ]
        
        for pattern in date_patterns:
            entities["dates"].extend(re.findall(pattern, text, re.IGNORECASE))
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∏—Å–µ–ª –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        number_patterns = [
            r'\d+%',           # –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            r'\d+[\.,]\d+',    # –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ —á–∏—Å–ª–∞
            r'\d{1,3}[,\s]?\d{3}',  # –±–æ–ª—å—à–∏–µ —á–∏—Å–ª–∞
            r'\$\d+',          # –¥–µ–Ω—å–≥–∏
            r'\d+‚ÇΩ',           # —Ä—É–±–ª–∏
        ]
        
        for pattern in number_patterns:
            entities["numbers"].extend(re.findall(pattern, text))
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
        name_pattern = r'\b[–ê-–Ø–Å][–∞-—è—ë]+\s+[–ê-–Ø–Å][–∞-—è—ë]+\b'
        entities["names"] = re.findall(name_pattern, text)
        
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π
        action_keywords = ["—Ä–µ—à–∏–ª–∏", "–ø–ª–∞–Ω–∏—Ä—É–µ–º", "—Å–¥–µ–ª–∞–µ–º", "–Ω–∞—á–Ω–µ–º", "–∑–∞–ø—É—Å—Ç–∏–º", "—Ä–µ–∞–ª–∏–∑—É–µ–º", "–æ–±—Å—É–¥–∏–º"]
        decision_keywords = ["—Ä–µ—à–µ–Ω–∏–µ", "–≤—ã–≤–æ–¥", "–∑–∞–∫–ª—é—á–µ–Ω–∏–µ", "–∏—Ç–æ–≥", "—Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å"]
        
        sentences = text.split('.')
        for sentence in sentences:
            sentence_lower = sentence.lower().strip()
            if any(keyword in sentence_lower for keyword in action_keywords):
                entities["actions"].append(sentence.strip())
            if any(keyword in sentence_lower for keyword in decision_keywords):
                entities["decisions"].append(sentence.strip())
        
        return entities
    
    async def smart_summarize(self, text: str, source_type: str = "text", 
                            source_name: str = "", compression_ratio: float = 0.3) -> Dict[str, str]:
        """–°–æ–∑–¥–∞–µ—Ç —É–º–Ω—É—é —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤"""
        try:
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            content_type = self.analyze_content_type(text, source_type)
            logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {content_type}")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
            entities = self.extract_key_entities(text)
            
            # –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            summary_prompt = self._create_specialized_prompt(text, content_type, entities, compression_ratio)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é –æ—Ç Groq
            response = self.groq_client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—é–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∏–∑–≤–ª–µ—á—å —Å–∞–º—É—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –µ—ë –≤ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ."
                    },
                    {
                        "role": "user",
                        "content": summary_prompt
                    }
                ],
                model="llama-3.3-70b-versatile",
                max_tokens=1000,
                temperature=0.2
            )
            
            smart_summary = response.choices[0].message.content.strip()
            
            # –°–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤
            insights_prompt = self._create_insights_prompt(text, entities)
            
            insights_response = self.groq_client.chat.completions.create(
                messages=[
                    {
                        "role": "system",
                        "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –∫–ª—é—á–µ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤. –í—ã–¥–µ–ª–∏ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã, —Ä–µ—à–µ–Ω–∏—è –∏ –≤—ã–≤–æ–¥—ã."
                    },
                    {
                        "role": "user",
                        "content": insights_prompt
                    }
                ],
                model="llama-3.3-70b-versatile",
                max_tokens=500,
                temperature=0.1
            )
            
            key_insights = insights_response.choices[0].message.content.strip()
            
            return {
                "content_type": content_type,
                "smart_summary": smart_summary,
                "key_insights": key_insights,
                "entities": entities
            }
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–º–Ω–æ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏: {e}")
            return {
                "content_type": "unknown",
                "smart_summary": f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É–º–Ω–æ–≥–æ —Ä–µ–∑—é–º–µ: {str(e)}",
                "key_insights": "",
                "entities": {}
            }
    
    def _create_specialized_prompt(self, text: str, content_type: str, entities: Dict, compression_ratio: float) -> str:
        """–°–æ–∑–¥–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        
        base_requirements = f"""
–°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ (—Å–∂–∞—Ç–∏–µ: {compression_ratio:.0%}).
–°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ, —á—Ç–æ –∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç.
"""
        
        type_specific_formats = {
            "meeting": """
–§–æ—Ä–º–∞—Ç —Ä–µ–∑—é–º–µ –¥–ª—è –≤—Å—Ç—Ä–µ—á–∏:
üè¢ **–û–°–ù–û–í–ù–´–ï –¢–ï–ú–´:**
‚Ä¢ –ì–ª–∞–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ–±—Å—É–∂–¥–µ–Ω–∏—è (2-3 –ø—É–Ω–∫—Ç–∞)

üìã **–†–ï–®–ï–ù–ò–Ø –ò –î–û–ì–û–í–û–†–ï–ù–ù–û–°–¢–ò:**
‚Ä¢ –ü—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è (2-4 –ø—É–Ω–∫—Ç–∞)

üéØ **–î–ï–ô–°–¢–í–ò–Ø –ò –ó–ê–î–ê–ß–ò:**
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (2-3 –ø—É–Ω–∫—Ç–∞)

‚è∞ **–í–ê–ñ–ù–´–ï –î–ê–¢–´ –ò –°–†–û–ö–ò:**
‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏
""",
            
            "lecture": """
–§–æ—Ä–º–∞—Ç —Ä–µ–∑—é–º–µ –¥–ª—è –ª–µ–∫—Ü–∏–∏/—É—Ä–æ–∫–∞:
üìö **–ì–õ–ê–í–ù–ê–Ø –¢–ï–ú–ê:**
‚Ä¢ –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–µ–¥–º–µ—Ç –∏–∑—É—á–µ–Ω–∏—è

üîë **–ö–õ–Æ–ß–ï–í–´–ï –ö–û–ù–¶–ï–ü–¶–ò–ò:**
‚Ä¢ –í–∞–∂–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (3-5 –ø—É–Ω–∫—Ç–æ–≤)

üí° **–û–°–ù–û–í–ù–´–ï –í–´–í–û–î–´:**
‚Ä¢ –ì–ª–∞–≤–Ω—ã–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã (2-3 –ø—É–Ω–∫—Ç–∞)

üìñ **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–û–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–ï:**
‚Ä¢ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è
""",
            
            "news": """
–§–æ—Ä–º–∞—Ç —Ä–µ–∑—é–º–µ –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π:
üì∞ **–°–£–¢–¨ –°–û–ë–´–¢–ò–Ø:**
‚Ä¢ –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ - –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç

üë• **–£–ß–ê–°–¢–ù–ò–ö–ò:**
‚Ä¢ –ö—Ç–æ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω –≤ —Å–æ–±—ã—Ç–∏–∏

üìä **–ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–´ –ò –¶–ò–§–†–´:**
‚Ä¢ –í–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (2-4 –ø—É–Ω–∫—Ç–∞)

üîÆ **–ü–û–°–õ–ï–î–°–¢–í–ò–Ø:**
‚Ä¢ –ö —á–µ–º—É —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏
""",
            
            "discussion": """
–§–æ—Ä–º–∞—Ç —Ä–µ–∑—é–º–µ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è:
üí¨ **–ì–õ–ê–í–ù–´–ï –¢–ï–ú–´:**
‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –æ–±—Å—É–∂–¥–µ–Ω–∏—è (2-3 –ø—É–Ω–∫—Ç–∞)

üó£Ô∏è **–ö–õ–Æ–ß–ï–í–´–ï –ú–ù–ï–ù–ò–Ø:**
‚Ä¢ –í–∞–∂–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã (3-4 –ø—É–Ω–∫—Ç–∞)

ü§ù **–û–ë–õ–ê–°–¢–ò –°–û–ì–õ–ê–°–ò–Ø:**
‚Ä¢ –ü–æ —á–µ–º—É —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–∏—à–ª–∏ –∫ –µ–¥–∏–Ω–æ–º—É –º–Ω–µ–Ω–∏—é

‚öñÔ∏è **–°–ü–û–†–ù–´–ï –í–û–ü–†–û–°–´:**
‚Ä¢ –ß—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–¥–º–µ—Ç–æ–º –¥–∏—Å–∫—É—Å—Å–∏–∏
""",
            
            "general": """
–§–æ—Ä–º–∞—Ç —Ä–µ–∑—é–º–µ:
üìã **–û–°–ù–û–í–ù–û–ï –°–û–î–ï–†–ñ–ê–ù–ò–ï:**
‚Ä¢ –ì–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã –∏ –∏–¥–µ–∏ (2-3 –ø—É–Ω–∫—Ç–∞)

üîç **–ö–õ–Æ–ß–ï–í–´–ï –î–ï–¢–ê–õ–ò:**
‚Ä¢ –í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (3-5 –ø—É–Ω–∫—Ç–æ–≤)

üí° **–í–´–í–û–î–´:**
‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è (1-2 –ø—É–Ω–∫—Ç–∞)
"""
        }
        
        format_instruction = type_specific_formats.get(content_type, type_specific_formats["general"])
        
        prompt = f"""{base_requirements}

{format_instruction}

–ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É —Å —Ä–µ–∑—é–º–µ, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π.

–ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢:
{text}"""
        
        return prompt
    
    def _create_insights_prompt(self, text: str, entities: Dict) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤"""
        
        entities_context = ""
        if entities["dates"]:
            entities_context += f"–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã: {', '.join(entities['dates'][:3])}\n"
        if entities["numbers"]:
            entities_context += f"–í–∞–∂–Ω—ã–µ —Ü–∏—Ñ—Ä—ã: {', '.join(entities['numbers'][:5])}\n"
        if entities["names"]:
            entities_context += f"–£–ø–æ–º—è–Ω—É—Ç—ã–µ –∏–º–µ–Ω–∞: {', '.join(entities['names'][:3])}\n"
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –∏ –≤—ã–¥–µ–ª–∏ –¢–û–õ–¨–ö–û —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã.

{entities_context}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üéØ **–ö–õ–Æ–ß–ï–í–´–ï –ò–ù–°–ê–ô–¢–´:**
‚Ä¢ –°–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ñ–∞–∫—Ç –∏–ª–∏ –≤—ã–≤–æ–¥
‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–ª–∏ —Ä–µ—à–µ–Ω–∏–µ
‚Ä¢ –ì–ª–∞–≤–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–∞–∫—Å–∏–º—É–º 3 –ø—É–Ω–∫—Ç–∞. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –∑–Ω–∞—á–∏–º—ã–º.
–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ, —á—Ç–æ –∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç.

–¢–ï–ö–°–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
{text}"""
        
        return prompt
    
    def format_smart_response(self, result: Dict, source_info: str, original_length: int, 
                            processing_time: float = 0) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É–º–Ω–æ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–µ–π"""
        
        content_type_names = {
            "meeting": "–≤—Å—Ç—Ä–µ—á–∏/—Å–æ–±—Ä–∞–Ω–∏—è",
            "lecture": "–ª–µ–∫—Ü–∏–∏/—É—Ä–æ–∫–∞", 
            "news": "–Ω–æ–≤–æ—Å—Ç–µ–π",
            "interview": "–∏–Ω—Ç–µ—Ä–≤—å—é",
            "presentation": "–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏",
            "discussion": "–æ–±—Å—É–∂–¥–µ–Ω–∏—è/–¥–∏—Å–∫—É—Å—Å–∏–∏",
            "instruction": "–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏/—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞",
            "review": "–æ–±–∑–æ—Ä–∞/—Ä–µ—Ü–µ–Ω–∑–∏–∏",
            "general": "–æ–±—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞"
        }
        
        content_type_display = content_type_names.get(result["content_type"], "—Ç–µ–∫—Å—Ç–∞")
        
        response = f"""üß† **–£–º–Ω–æ–µ —Ä–µ–∑—é–º–µ {content_type_display}**

{result["smart_summary"]}

{result["key_insights"]}"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Å—É—â–Ω–æ—Å—Ç—è–º
        entities_stats = []
        if result["entities"]["dates"]:
            entities_stats.append(f"üìÖ –î–∞—Ç—ã: {len(result['entities']['dates'])}")
        if result["entities"]["numbers"]:
            entities_stats.append(f"üî¢ –¶–∏—Ñ—Ä—ã: {len(result['entities']['numbers'])}")
        if result["entities"]["names"]:
            entities_stats.append(f"üë• –ò–º–µ–Ω–∞: {len(result['entities']['names'])}")
        if result["entities"]["actions"]:
            entities_stats.append(f"‚ö° –î–µ–π—Å—Ç–≤–∏—è: {len(result['entities']['actions'])}")
        
        if entities_stats:
            response += f"\n\nüìä **–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**\n‚Ä¢ " + " ‚Ä¢ ".join(entities_stats)
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        summary_length = len(result["smart_summary"]) + len(result["key_insights"])
        compression_ratio = summary_length / original_length if original_length > 0 else 0
        
        response += f"""

üìà **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:**
‚Ä¢ –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç: {original_length:,} —Å–∏–º–≤–æ–ª–æ–≤
‚Ä¢ –£–º–Ω–æ–µ —Ä–µ–∑—é–º–µ: {summary_length:,} —Å–∏–º–≤–æ–ª–æ–≤
‚Ä¢ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ: {compression_ratio:.1%}
‚Ä¢ –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {content_type_display}"""
        
        if processing_time > 0:
            response += f"\n‚Ä¢ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {processing_time:.1f}—Å"
            
        return response