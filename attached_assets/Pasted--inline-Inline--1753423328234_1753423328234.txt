# –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å inline –∫–Ω–æ–ø–∫–∞–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞
Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å–∂–∞—Ç–∏—è –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ. –ù—É–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Telegram API.

## –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤—å –º–µ—Ç–æ–¥ send_message
–í –º–µ—Ç–æ–¥–µ `send_message` –ø–æ–ø—Ä–æ–±—É–π –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

```python
async def send_message(self, chat_id: int, text: str, parse_mode: Optional[str] = None, reply_markup: dict = None):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä"""
    url = f"{self.base_url}/sendMessage"
    data = {
        "chat_id": chat_id,
        "text": text[:4096]
    }
    if parse_mode:
        data["parse_mode"] = parse_mode
    if reply_markup:
        data["reply_markup"] = json.dumps(reply_markup)  # –í–ï–†–ù–ò json.dumps!
    
    try:
        async with aiohttp.ClientSession() as session:
            # –ü–æ–ø—Ä–æ–±—É–π data= –≤–º–µ—Å—Ç–æ json= –¥–ª—è Telegram API
            async with session.post(url, data=data) as response:
                result = await response.json()
                # –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

### 2. –î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è callback_query
–í –Ω–∞—á–∞–ª–æ –º–µ—Ç–æ–¥–∞ `get_updates` –¥–æ–±–∞–≤—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```python
async def get_updates(self, offset = None, timeout: int = 30):
    url = f"{self.base_url}/getUpdates"
    params = {
        "timeout": timeout,
        "allowed_updates": ["message", "callback_query"]  # –£–ë–ï–î–ò–°–¨ —á—Ç–æ —ç—Ç–æ –µ—Å—Ç—å
    }
    
    logger.info(f"üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å offset={offset}")
    # –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥...
    
    # –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è result –¥–æ–±–∞–≤—å:
    if updates and updates.get("ok"):
        update_list = updates.get("result", [])
        for update in update_list:
            if "callback_query" in update:
                logger.info(f"üéØ –ü–û–õ–£–ß–ï–ù CALLBACK_QUERY: {update['callback_query']}")
```

### 3. –ü–æ–ø—Ä–æ–±—É–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
–í –º–µ—Ç–æ–¥–µ `send_compression_level_menu` –ø–æ–ø—Ä–æ–±—É–π —Ç–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç:

```python
async def send_compression_level_menu(self, chat_id: int):
    text = """‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏

–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–∂–∞—Ç–∏—è —Ç–µ–∫—Å—Ç–∞:

üî• 10% - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (—Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ)
üìù 30% - –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (–æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã)  
üìÑ 50% - –£–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (–ø–æ–¥—Ä–æ–±–Ω–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ)"""
    
    # –ü–æ–ø—Ä–æ–±—É–π –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç
    keyboard = {
        "inline_keyboard": [
            [
                {"text": "üî• 10%", "callback_data": "compression_10"},
                {"text": "üìù 30%", "callback_data": "compression_30"},
                {"text": "üìÑ 50%", "callback_data": "compression_50"}
            ]
        ]
    }
    
    # –î–æ–±–∞–≤—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    logger.info(f"üìã –û—Ç–ø—Ä–∞–≤–ª—è—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É: {json.dumps(keyboard, ensure_ascii=False)}")
    
    result = await self.send_message(chat_id, text, reply_markup=keyboard)
    logger.info(f"üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π: {result}")
    
    # –î–û–ë–ê–í–¨ –¢–ï–°–¢ - –æ—Ç–ø—Ä–∞–≤—å –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ
    test_result = await self.send_message(chat_id, "‚ö†Ô∏è –¢–µ—Å—Ç: –µ—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –≤—ã—à–µ")
    logger.info(f"üß™ –¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {test_result}")
    
    return result
```

### 4. –î–æ–±–∞–≤—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º
–ï—Å–ª–∏ inline –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –¥–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤:

```python
async def handle_summarize_command(self, update: dict):
    # —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥...
    
    menu_result = await self.send_compression_level_menu(chat_id)
    
    # –î–û–ë–ê–í–¨ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    backup_text = """
üí° –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–º:
‚Ä¢ "10%" - –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–∂–∞—Ç–∏—è
‚Ä¢ "30%" - –¥–ª—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∂–∞—Ç–∏—è  
‚Ä¢ "50%" - –¥–ª—è —É–º–µ—Ä–µ–Ω–Ω–æ–≥–æ —Å–∂–∞—Ç–∏—è"""
    
    await self.send_message(chat_id, backup_text)
```

### 5. –î–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
–í –º–µ—Ç–æ–¥ `handle_text_message` –¥–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É:

```python
# –í –Ω–∞—á–∞–ª–µ handle_text_message, –ø–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è text:
if user_id in self.user_states and self.user_states[user_id].get("step") == "compression_level":
    if text in ["10%", "30%", "50%"]:
        # –ò–º–∏—Ç–∏—Ä—É–µ–º callback
        fake_callback = {
            "id": "manual_" + str(time.time()),
            "from": {"id": user_id},
            "message": {"chat": {"id": chat_id}, "message_id": 1},
            "data": f"compression_{text.replace('%', '')}"
        }
        await self.handle_callback_query(fake_callback)
        return
```

## –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π:

1. **–°–ù–ê–ß–ê–õ–ê** –≤–µ—Ä–Ω–∏ `json.dumps(reply_markup)` –≤ –º–µ—Ç–æ–¥–µ `send_message`
2. **–ó–ê–¢–ï–ú** –∑–∞–º–µ–Ω–∏ `json=data` –Ω–∞ `data=data` –≤ —Ç–æ–º –∂–µ –º–µ—Ç–æ–¥–µ
3. **–î–û–ë–ê–í–¨** –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `get_updates`
4. **–î–û–ë–ê–í–¨** —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
5. **–ü–†–û–¢–ï–°–¢–ò–†–£–ô** - —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ 10%/30%/50% –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
- –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ callback_query
- –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å "10%" —Ç–µ–∫—Å—Ç–æ–º

**–ù–ï –ú–ï–ù–Ø–ô** –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–µ - —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è!